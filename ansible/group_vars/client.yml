---
# Client — Raspberry Pi 5: follower, swerve, sensors, master2master
# Network (netplan) and hostname — set for each host or here for the group:
network_address: "192.168.1.34/24"
network_gateway: "192.168.1.1"
network_nameservers: ["1.1.1.1"]
hostname: "client-rpi5"

# Server IP/hostname for master2master to connect to Server's ROS2 master (set or use inventory).
ros2_server_host: "192.168.1.33"   # or server hostname if DNS/resolution works

# ROS2 node types. Most client nodes stay localhost-only; master2master must reach server ROS graph.
ros2_node_type_defaults:
  ros2_master:
    image: harbor.szymonrichert.pl/containers/client-ros2-master:latest
    build_context: nodes/ros2_master
    env:
      - ROS_LOCALHOST_ONLY=1
  master2master:
    image: harbor.szymonrichert.pl/containers/client-master2master:latest
    build_context: nodes/master2master
    config_path: /etc/ros2/master2master
    env:
      - ROS_LOCALHOST_ONLY=0
      - ROS_AUTOMATIC_DISCOVERY_RANGE=SUBNET
      - MASTER2MASTER_CONFIG=/etc/ros2/master2master/config.yaml
      # ROS2_SERVER_HOST passed per-node below so master2master can connect to Server's ROS2 master
  feetech_servos:
    image: harbor.szymonrichert.pl/containers/client-feetech-servos-follower:latest
    build_context: nodes/bridges/feetech_servos
    config_path: /etc/ros2/feetech_servos
    env:
      - ROS_LOCALHOST_ONLY=0
      - ROS_AUTOMATIC_DISCOVERY_RANGE=SUBNET
      - FEETECH_SERVOS_CONFIG=/etc/ros2/feetech_servos/config.yaml
  uvc_camera:
    image: harbor.szymonrichert.pl/containers/client-uvc-camera:latest
    build_context: nodes/bridges/uvc_camera
    env:
      - ROS_LOCALHOST_ONLY=1
  filter_node:
    image: harbor.szymonrichert.pl/containers/client-filter-node:latest
    build_context: nodes/filter_node
    config_path: /etc/ros2/filter_node
    env:
      - ROS_LOCALHOST_ONLY=0
      - ROS_AUTOMATIC_DISCOVERY_RANGE=SUBNET
      - FILTER_NODE_CONFIG=/etc/ros2/filter_node/config.yaml
  test_joint_api:
    image: harbor.szymonrichert.pl/containers/client-test-joint-api:latest
    build_context: nodes/test_joint_api
    config_path: /etc/ros2/test_joint_api
    env:
      - ROS_LOCALHOST_ONLY=0
      - ROS_AUTOMATIC_DISCOVERY_RANGE=SUBNET
      - TEST_JOINT_API_CONFIG=/etc/ros2/test_joint_api/config.yaml

# Nodes to deploy: name (logical/service name), node_type (maps to image/config), present, enabled, config.
ros2_nodes:
  - name: ros2-master
    node_type: ros2_master
    present: true
    enabled: true
    extra_args: --network host --ipc host
  - name: master2master
    node_type: master2master
    present: true
    enabled: true
    extra_args: --network host --ipc host
    config: |
      topics:
        - source: /server/cmd_vel
          dest: /client/cmd_vel
          direction: in
        - source: /client/odom
          dest: /server/odom
          direction: out
        - source: /leader/joint_states
          dest: /filter/input_joint_updates
          direction: in
          type: JointState
  - name: filter_node
    node_type: filter_node
    present: true
    enabled: true
    extra_args: --network host --ipc host
    config: |
      input_topic: /filter/input_joint_updates
      output_topic: /follower/joint_commands
      algorithm: kalman
      control_loop_hz: 100
      joint_names:
        - joint_1
        - joint_2
        - joint_3
        - joint_4
        - joint_5
        - joint_6
      algorithm_params:
        process_noise_pos: 0.00022
        process_noise_vel: 0.014
        measurement_noise: 3e-5
        prediction_lead_s: 0.035
        velocity_decay_per_s: 4.5
        max_prediction_time_s: 0.14
  - name: test_joint_api
    node_type: test_joint_api
    present: true
    enabled: true
    extra_args: --network host --ipc host
    config: |
      host: "0.0.0.0"
      port: 18080
      topic: /filter/input_joint_updates
  - name: gripper_uvc_camera
    node_type: uvc_camera
    present: true
    enabled: true
    extra_args: >-
      --network host
      --ipc host
      --device=/dev/video0:/dev/video0
    env:
      - UVC_DEVICE=/dev/video0
      - UVC_TOPIC=/camera_0/image_raw
  - name: lerobot_follower
    node_type: feetech_servos
    present: true
    enabled: true
    extra_args: >-
      --network host
      --ipc host
      --device=/dev/ttyACM0:/dev/ttyACM0
      --mount type=bind,src=/dev/serial/by-id,dst=/dev/serial/by-id,readonly
    config: |
      device: /dev/serial/by-id/usb-1a86_USB_Single_Serial_5A7A059004-if00
      namespace: follower
      log_joint_updates: true
      enable_torque_on_start: true
      register_publish_interval_s: 10
      joint_names:
        - name: joint_1
          id: 1
        - name: joint_2
          id: 2
        - name: joint_3
          id: 3
        - name: joint_4
          id: 4
        - name: joint_5
          id: 5
        - name: joint_6
          id: 6
