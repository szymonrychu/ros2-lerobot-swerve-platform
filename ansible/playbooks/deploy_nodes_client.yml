---
# Deploy ROS2 nodes on Client: clone repo, build or pull containers, systemd + config.
# Node list and config from group_vars/client.yml; repo from group_vars/all.yml.
# When ros2_build_on_controller is true, images are built on the controller and pushed;
# the client only pulls (avoids DNS/network failures during docker build on the Pi).
# Run from ansible/: ansible-playbook -i inventory playbooks/deploy_nodes_client.yml -l client

- name: Build and push node images on controller
  hosts: client
  gather_facts: false
  vars:
    _unique_types: "{{ ros2_nodes | map(attribute='node_type') | unique | list }}"
  tasks:
    - name: Build and push each unique node image
      when: ros2_build_on_controller | default(false) | bool
      ansible.builtin.command:
        cmd: "docker build -t {{ ros2_node_type_defaults[item].image }} {{ ros2_node_type_defaults[item].build_context }}"
        chdir: "{{ ros2_repo_root }}"
      loop: "{{ _unique_types }}"
      loop_control:
        label: "{{ ros2_node_type_defaults[item].image }}"
      delegate_to: localhost
      run_once: true

    - name: Push built images to registry
      when: ros2_build_on_controller | default(false) | bool
      ansible.builtin.command:
        cmd: "docker push {{ ros2_node_type_defaults[item].image }}"
      loop: "{{ _unique_types }}"
      loop_control:
        label: "{{ ros2_node_type_defaults[item].image }}"
      delegate_to: localhost
      run_once: true

- name: Deploy Client ROS2 nodes
  hosts: client
  become: true
  pre_tasks:
    - name: Ensure repo directory exists
      ansible.builtin.file:
        path: "{{ ros2_repo_dest }}"
        state: directory
        mode: "0755"
      become: true

    - name: Clone or update repo for local builds
      ansible.builtin.git:
        repo: "{{ ros2_repo_url }}"
        dest: "{{ ros2_repo_dest }}"
        version: "{{ ros2_repo_revision }}"
        force: true
        update: true
      become: true

  tasks:
    - name: Deploy each ROS2 node
      ansible.builtin.include_role:
        name: ros2_node_deploy
      vars:
        _master2master_server_env: "{{ ['ROS2_SERVER_HOST=' + ros2_server_host] if (item.node_type == 'master2master' and ros2_server_host is defined and ros2_server_host | length > 0) else [] }}"
        node_name: "{{ item.name }}"
        node_present: "{{ item.present | default(true) }}"
        node_enabled: "{{ item.enabled | default(true) }}"
        node_config: "{{ item.config | default('') }}"
        node_image: "{{ ros2_node_type_defaults[item.node_type].image }}"
        node_build_context: "{{ ros2_node_type_defaults[item.node_type].build_context }}"
        repo_dest: "{{ ros2_repo_dest }}"
        node_config_path: "{{ ros2_node_type_defaults[item.node_type].config_path | default(omit) }}"
        node_build_on_controller: "{{ ros2_build_on_controller | default(false) }}"
        node_env: "{{ (ros2_node_type_defaults[item.node_type].env | default([])) + (item.env | default([])) + _master2master_server_env }}"
        node_extra_args: "{{ item.extra_args | default('') }}"
      loop: "{{ ros2_nodes }}"
      loop_control:
        label: "{{ item.name }}"
