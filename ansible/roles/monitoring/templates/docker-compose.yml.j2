# Monitoring stack: Alloy, Mimir, Loki, Grafana. All on localhost; no HA.
# Generated by Ansible role monitoring.

services:
  mimir:
    image: {{ monitoring_mimir_image }}
    command: ["-config.file=/etc/mimir/mimir.yml"]
    volumes:
      - {{ monitoring_data_dir }}/mimir:/data
      - {{ monitoring_data_dir }}/mimir/mimir.yml:/etc/mimir/mimir.yml:ro
    restart: unless-stopped
    networks:
      - monitoring

  loki:
    image: {{ monitoring_loki_image }}
    command: ["-config.file=/etc/loki/loki.yml"]
    volumes:
      - {{ monitoring_data_dir }}/loki:/data
      - {{ monitoring_data_dir }}/loki/loki.yml:/etc/loki/loki.yml:ro
    restart: unless-stopped
    networks:
      - monitoring

  alloy:
    image: {{ monitoring_alloy_image }}
    command: ["run", "/config/alloy.alloy"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - {{ monitoring_data_dir }}/alloy/alloy.alloy:/config/alloy.alloy:ro
    depends_on:
      - mimir
      - loki
    restart: unless-stopped
    networks:
      - monitoring

  grafana:
    image: {{ monitoring_grafana_image }}
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_SERVER_HTTP_PORT: "3000"
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
    volumes:
      - {{ monitoring_data_dir }}/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
    ports:
      - "{{ monitoring_grafana_http_port }}:3000"
    depends_on:
      - mimir
      - loki
    restart: unless-stopped
    networks:
      - monitoring

networks:
  monitoring:
    driver: bridge
