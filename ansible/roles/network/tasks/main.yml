---
# Configure static IP on primary interface (ethernet or wlan); other interfaces set to DHCP. IPv6 disabled.
# Requires: network_address (CIDR), network_gateway.
# Optional: network_interface (default: primary IPv4 interface), network_nameservers.
# For primary wlan: network_wifi_ssid (required), network_wifi_password (optional).

- name: Validate network variables
  ansible.builtin.assert:
    that:
      - network_address is defined
      - network_address | length > 0
      - network_gateway is defined
      - network_gateway | length > 0
    fail_msg: "network role requires network_address and network_gateway (set in group_vars or host_vars)."
    success_msg: "Network vars present"

- name: Set primary interface (explicit or default IPv4)
  ansible.builtin.set_fact:
    _network_interface: "{{ network_interface | default(ansible_facts['default_ipv4']['interface']) }}"
  when: network_interface is defined and network_interface | length > 0

- name: Set primary interface from default IPv4
  ansible.builtin.set_fact:
    _network_interface: "{{ ansible_facts['default_ipv4']['interface'] }}"
  when: network_interface is not defined or network_interface | length == 0

- name: Set whether primary is wireless (wl*)
  ansible.builtin.set_fact:
    _network_interface_is_wlan: "{{ _network_interface is match('^wl') }}"

- name: Require network_wifi_ssid when primary interface is WiFi
  ansible.builtin.assert:
    that: network_wifi_ssid is defined and network_wifi_ssid | length > 0
    fail_msg: "network role requires network_wifi_ssid when primary interface ({{ _network_interface }}) is WiFi. Set in group_vars or host_vars."
  when: _network_interface_is_wlan | bool

- name: Set list of other interfaces (exclude lo and primary)
  ansible.builtin.set_fact:
    _other_interfaces: "{{ ansible_facts['interfaces'] | default([]) | reject('match', '^lo$') | reject('equalto', _network_interface) | list }}"

- name: Set other ethernet-like interfaces (for DHCP in template)
  ansible.builtin.set_fact:
    _other_ethernets: "{{ _other_interfaces | reject('match', '^wl') | list }}"

- name: Ensure netplan config directory exists
  ansible.builtin.file:
    path: /etc/netplan
    state: directory
    mode: "0755"
  become: true

- name: Deploy netplan configuration
  ansible.builtin.template:
    src: netplan.yaml.j2
    dest: "/etc/netplan/{{ network_netplan_file }}"
    mode: "0600"
  become: true
  register: netplan_config

- name: Apply netplan (only when config changed)
  ansible.builtin.command:
    cmd: netplan apply
  become: true
  when: netplan_config is changed
