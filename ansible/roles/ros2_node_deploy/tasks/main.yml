---
# Deploy or uninstall a ROS2 node as a systemd service (container).
# Expects (from playbook): node_name, node_image, node_build_context, repo_dest,
# node_present, node_enabled; optionally node_config_path, node_config, node_env, node_extra_args.
# Playbook resolves node_type -> image/config_path/env via ros2_node_type_defaults.

- name: Validate required variables for ROS2 node deploy
  ansible.builtin.assert:
    that:
      - node_name is defined
      - node_name | length > 0
      - node_image is defined
      - node_image | length > 0
      - node_build_context is defined
      - repo_dest is defined
    fail_msg: "ros2_node_deploy requires node_name, node_image, node_build_context, repo_dest (from playbook loop)."
    success_msg: "Required vars present for {{ node_name }}"

- name: Set current node name for handlers
  ansible.builtin.set_fact:
    ros2_node_restart_now: "{{ node_name }}"

- name: Validate feetech_servos node config schema (name+id per joint)
  when:
    - node_present | default(true) | bool
    - node_type is defined
    - node_type == "feetech_servos"
  vars:
    _feetech_cfg: "{{ (node_config | default('') | from_yaml) if (node_config | default('') | trim | length > 0) else {} }}"
  ansible.builtin.assert:
    that:
      - _feetech_cfg is mapping
      - _feetech_cfg.namespace is defined
      - _feetech_cfg.joint_names is defined
      - _feetech_cfg.joint_names is sequence
      - _feetech_cfg.joint_names | length > 0
      - (_feetech_cfg.joint_names | select('mapping') | list | length) == (_feetech_cfg.joint_names | length)
      - (_feetech_cfg.joint_names | selectattr('name', 'defined') | list | length) == (_feetech_cfg.joint_names | length)
      - (_feetech_cfg.joint_names | selectattr('id', 'defined') | list | length) == (_feetech_cfg.joint_names | length)
    fail_msg: >-
      feetech_servos node '{{ node_name }}' requires config.joint_names as list of
      objects with both name and id (e.g. [{name: joint_1, id: 1}, ...]).

- name: Uninstall ROS2 node (present is false)
  when: not (node_present | default(true) | bool)
  block:
    - name: Stop ROS2 node service
      ansible.builtin.service:
        name: "ros2-{{ node_name }}"
        state: stopped
      become: true
      ignore_errors: true

    - name: Disable ROS2 node service
      ansible.builtin.service:
        name: "ros2-{{ node_name }}"
        enabled: false
      become: true
      ignore_errors: true

    - name: Remove systemd unit for ROS2 node
      ansible.builtin.file:
        path: "/etc/systemd/system/ros2-{{ node_name }}.service"
        state: absent
      become: true

    - name: Remove ROS2 node config directory
      ansible.builtin.file:
        path: "{{ ros2_node_config_dir }}/{{ node_name }}"
        state: absent
      become: true

    - name: Reload systemd after uninstall
      ansible.builtin.systemd:
        daemon_reload: true
      become: true

- name: Deploy ROS2 node (present is true)
  when: node_present | default(true) | bool
  block:
    - name: Pull node container image from registry
      when: node_build_on_controller | default(false) | bool
      ansible.builtin.command:
        cmd: "docker pull {{ node_image }}"
      become: true
      register: docker_pull_result
      changed_when: docker_pull_result.rc == 0

    - name: Build node container image from repo
      when: not (node_build_on_controller | default(false) | bool)
      ansible.builtin.command:
        cmd: "docker build --network=host -t {{ node_image }} {{ node_build_context }}"
        chdir: "{{ repo_dest }}"
      become: true
      register: docker_build_result
      changed_when: docker_build_result.rc == 0

    - name: Ensure ROS2 node config directory exists
      ansible.builtin.file:
        path: "{{ ros2_node_config_dir }}/{{ node_name }}"
        state: directory
        mode: "0755"
      become: true

    - name: Deploy node config file (when config_path is set)
      ansible.builtin.copy:
        dest: "{{ ros2_node_config_dir }}/{{ node_name }}/config.yaml"
        content: "{{ node_config | default('') }}"
        mode: "0644"
      become: true
      when: node_config_path is defined and node_config_path is string and (node_config_path | length > 0)
      notify: "Restart ROS2 node"

    - name: Create systemd unit for ROS2 node
      ansible.builtin.template:
        src: ros2-node.service.j2
        dest: "/etc/systemd/system/ros2-{{ node_name }}.service"
        mode: "0644"
      become: true
      notify:
        - "Reload systemd"
        - "Restart ROS2 node"

    - name: Set service state and enabled according to node_enabled
      ansible.builtin.service:
        name: "ros2-{{ node_name }}"
        state: "{{ 'started' if (node_enabled | default(true) | bool) else 'stopped' }}"
        enabled: "{{ node_enabled | default(true) | bool }}"
        daemon_reload: true
      become: true

    - name: Flush handlers so restart runs with current node when role is used in a loop
      ansible.builtin.meta: flush_handlers
